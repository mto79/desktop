#!/usr/bin/env bash

[[ -f ~/.config/user-dirs.dirs ]] && source ~/.config/user-dirs.dirs
OUTPUT_DIR="${DESKTOP_SCREENRECORD_DIR:-${XDG_VIDEOS_DIR:-$HOME/Videos}}"

if [[ ! -d "$OUTPUT_DIR" ]]; then
  notify-send -u critical -t 3000 "Screen recording directory does not exist: $OUTPUT_DIR"
  exit 1
fi

# Selects region or output
SCOPE="$1"

# Selects audio inclusion or not
AUDIO=$([[ $2 == "audio" ]] && echo "--audio")

start_screenrecording() {
  local filename="$OUTPUT_DIR/screenrecording-$(date +'%Y-%m-%d_%H-%M-%S').mp4"

  wf-recorder "$AUDIO" -f "$filename" "$@" &>/dev/null &
  local wf_pid=$!

  if ps -p $wf_pid >/dev/null; then
    toggle_screenrecording_indicator
  else
    notify-send -u critical -t 3000 "Screen recording failed" "wf-recorder did not start"
    exit 1
  fi
}

stop_screenrecording() {
  pkill -x wf-recorder

  notify-send "Screen recording saved to $OUTPUT_DIR" -t 2000

  sleep 1 # ensures the process is actually dead before we check
  toggle_screenrecording_indicator
}

toggle_screenrecording_indicator() {
  pkill -RTMIN+8 waybar
}

screenrecording_active() {
  pgrep -x wf-recorder >/dev/null
}

if screenrecording_active; then
  stop_screenrecording
  echo "Stopped recording"
elif [[ "$SCOPE" == "output" ]]; then
  output=$(slurp -o) || exit 1
  start_screenrecording -g "$output"
  echo "Started screen recording"
else
  region=$(slurp) || exit 1
  start_screenrecording -g "$region"
  echo "Started region recording"
fi
