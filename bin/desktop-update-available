#!/usr/bin/env bash

# Desktop updates via git
latest_tag=$(git -C "$DESKTOP_PATH" ls-remote --tags origin | grep -v "{}" | awk '{print $2}' | sed 's#refs/tags/##' | sort -V | tail -n 1)
if [[ -z "$latest_tag" ]]; then
  echo "Error: Could not retrieve latest tag."
  exit 1
fi

current_tag=$(git -C "$DESKTOP_PATH" describe --tags "$(git -C "$DESKTOP_PATH" rev-list --tags --max-count=1)")
if [[ -z "$current_tag" ]]; then
  echo "Error: Could not retrieve current tag."
  exit 1
fi

if [[ "$current_tag" != "$latest_tag" ]]; then
  echo "desktop update available ($latest_tag) via git"
fi

# Fedora system package updates via dnf
if desktop-cmd-present dnf; then
  dnf -q makecache --refresh >/dev/null 2>&1
  if dnf -q check-upgrade >/dev/null 2>&1; then
    :
  elif [[ $? -eq 100 ]]; then
    echo "Fedora system package updates available via dnf"
  fi
fi

# Firmware updates via fwupdmgr
if desktop-cmd-present fwupdmgr; then
  fwupdmgr refresh --force >/dev/null 2>&1
  if fwupdmgr get-updates 2>/dev/null | grep -qiE 'update available|upgrade available'; then
    echo "Firmware updates available via fwupdmgr"
  fi
fi

# Flatpak updates
if desktop-cmd-present flatpak; then
  flatpak update --appstream -y >/dev/null 2>&1
  if flatpak remote-ls --updates --app --runtime --columns=application 2>/dev/null | grep -q .; then
    echo "Flatpak updates available via flatpak"
  fi
fi

# Cargo built binaries (via cargo-update)
if desktop-cmd-present cargo && cargo install-update --version >/dev/null 2>&1; then
  if cargo install-update --list 2>/dev/null | awk 'NR>1 && $NF=="Yes"{found=1} END{exit !found}'; then
    echo "Cargo-installed binary updates available via cargo install-update"
  fi
fi
